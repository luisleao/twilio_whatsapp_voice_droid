<!-- This is intended to be a sandbox file for testing and debugging Hex values of commands send to the Droid. Clearly not production grade code... -->

<html>

<body>
    <button id="ble">Pair with Droid</button>
    <br />
    <input id="hex" placeholder="Hex instruction" value="2500 0C42 0502"><button id="send">Send instruction</button>
    <script>

        const serviceUuid = '09b600a0-3e42-41fc-b474-e9c0c8f0c801';
        const notificationUuid = '09b600b0-3e42-41fc-b474-e9c0c8f0c801';
        const writeUuid = '09b600b1-3e42-41fc-b474-e9c0c8f0c801';

        var writeC;
        var ws;

        const fromHexString = hexString =>
            new Uint8Array(hexString.replace(/\s+/g, '').match(/.{1,2}/g).map(byte => parseInt(byte, 16)));

        document.getElementById('ble').addEventListener('click', function () {

            navigator.bluetooth.requestDevice({
                optionalServices: [serviceUuid],
                filters: [{
                    name: 'DROID'
                }]
            })
                .then(device => {
                    window.device = device;
                    device.addEventListener('gattserverdisconnected', function(event) {
                        console.log('GATT Server disconnected:', event.target);
                        alert('Droid disconnected. Please reconnect.');
                    });
                    console.log('Connecting to GATT Service...', device);
                    return device.gatt.connect()
                })
                .then(droid => {
                    window.gatt = droid;
                    console.log('Getting Droid...');
                    return droid.getPrimaryService(serviceUuid);
                })
                .then(service => {
                    window.service = service
                    console.log('Getting Characteristics...');
                    return service.getCharacteristics();
                })
                .then(characteristics => {
                    window.characteristics = characteristics;
                    characteristics.forEach(c => {
                        if (c.uuid === notificationUuid) {
                            return handleNotificationCharacteristic(c);
                        } else if (c.uuid === writeUuid) {
                            writeC = c;
                            return initialWrites();
                        }
                    });
                })
                .catch(error => {
                    console.log('Argh! ' + error);
                });
        });


        async function initialWrites() {
            await writeC.writeValue(fromHexString('222001'));
            await sleep(500);
            await writeC.writeValue(fromHexString('222001'));
            await sleep(500);
            await writeC.writeValue(fromHexString('222001'));
            await sleep(500);
            await writeC.writeValue(fromHexString('222001'));
            await sleep(500);
            await writeC.writeValue(fromHexString('2742 0f44 4400 1f00'));
            await sleep(10);
            await writeC.writeValue(fromHexString('27420f4444001802'));
            await sleep(500);
            await writeC.writeValue(fromHexString('27420f4444001f00'));
            await sleep(10);
            await writeC.writeValue(fromHexString('27420f4444001802'));
            await sleep(1000);
            connectWebSocket();

            setInterval(async () => {
                await writeC.writeValue(fromHexString('222001'));
            }, 30000);
            return writeC;
        }
        
        async function handleNotificationCharacteristic(c) {
            c = await c.startNotifications();
            return c.addEventListener('characteristicvaluechanged',
                handleCharacteristicValueChanged);
        }

        function handleCharacteristicValueChanged(event) {
            var value = event.target.value;
            console.log('Received ' + JSON.stringify(value));
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }


        document.getElementById('send').addEventListener('click', function () {
            const hex = document.getElementById('hex').value;
            writeC.writeValue(fromHexString(hex)).then(console.log).catch(console.log);
        });


        function connectWebSocket() {
            if (ws) {
                
            }
            ws = new WebSocket(`${window.location.protocol === 'https:' ? 'wss:' : 'ws:'}//${window.location.host}/robot`);
            ws.onmessage = function (event) {
                console.log('MESSAGE EVENT', event);
                const data = JSON.parse(event.data);
                console.log('NEW MESSAGE', data);

                (async () => {
                    for (const item of data) {
                        if (item.startsWith('DELAY:')) {
                            const ms = parseInt(item.split(':')[1], 10);
                            await sleep(ms);
                        } else {
                            await writeC.writeValue(fromHexString(item));
                        }
                    }
                })();

            };
            ws.onclose = function () {
                console.log('WebSocket desconectado. Tentando reconectar em 2s...');
                setTimeout(connectWebSocket, 2000);
            };
            ws.onerror = function (err) {
                console.log('WebSocket erro:', err);
                ws.close();
            };
        }

        
        /* Colinha dos Comandos

        // Sounds:
        // 2742 0F44 4400 1801 - inicio
        // 2742 0F44 4400 1007 - inicializacao

        // Sound Groups:
        // 2742 0F44 4400 1000 - interrupcão
        // 2742 0F44 4400 1001 - não
        // 2742 0F44 4400 1002 - sim

        // Sounds: 2742 0F44 4400 100A blasters

        // Rotate Head:
        // 2500 0C42 0102 - não (only R2)
        // 2500 0C42 0202 - 
        // 2500 0C42 0502 - não
        // 2500 0C42 0802 - start geral do setup na loja
        // 2500 0C42 0902 (se move rapido)
        // 2500 0C42 1002 - move a cabeça sem som e depois inicializa

        */

    </script>
</body>

</html>